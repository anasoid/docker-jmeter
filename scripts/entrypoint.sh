#!/bin/bash
set -e

echo "##################################### INIT default value ###########################################################"
. init-variables.sh
. functions-utils.sh
. csv-utils.sh
echo "############################################ printenv        ############################################"
printenv
echo "############################################ mvn -version    ############################################"
mvn -version

echo "############################################ java -version   ############################################"
java -version

echo "############################################ jmeter -version ############################################"
jmeter --version
echo "#########################################################################################################"
echo

echo "################################################################################################"

echo "############################################ WAIT READY FILE (START) ############################################"
wait-ready.sh
echo "############################################ WAIT READY FILE (END)   ############################################"
echo

echo "############################################ Download Maven dependencies (START) ############################################"
all-mvn-dependencies-download.sh
echo "############################################ Download Maven dependencies (END)   ############################################"
echo

echo "############################################ Copy Plugins (START) ############################################"
copy-plugins.sh
echo "############################################ Copy Plugins (END)   ############################################"
echo

echo "############################################ Download URL dependencies (START) ############################################"
download-zip-plugins.sh
echo "############################################ Download URL dependencies (END)   ############################################"
echo

echo "############################################ Prepare WORKSPACE (START) ############################################"
. prepare-workspace.sh
echo "############################################ Prepare WORKSPACE (END)   ############################################"
echo

echo "############################################ Prepare CSV (START) ############################################"
split_csv_file_all_csv
echo "############################################ Prepare CSV (END)   ############################################"
echo

echo "############################################ PRE-TEST (START) ############################################"
execute_scripts_before_test
echo "############################################ PRE-TEST (END)   ############################################"
echo

echo "############################################ PLUGIN-Manager-LOADING PLUGIN (START) ############################################"
plugins-manager-utils.sh
echo "############################################ PLUGIN-Manager-LOADING PLUGIN (END)   ############################################"
echo

echo "############################################ CHECK-Test (START) ############################################"
testplan-check-utils.sh
echo "############################################ CHECK-Test (END)   ############################################"
echo

echo "############################################ Execute-Test (START) ############################################"
sleep $CONF_EXEC_WAIT_BEFORE_TEST

if [[ ! "$JMETER_CHECK_ONLY" == "true" ]]; then
    jmeter-exec.sh $@
fi
echo "############################################ Execute-Test (END)   ############################################"
echo

echo "############################################ POST-TEST (START) ############################################"
execute_scripts_after_test
echo "############################################ POST-TEST (END)   ############################################"
sleep $CONF_EXEC_WAIT_AFTER_TEST
